{
  "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
  "title": {
    "text": "Tourist Arrivals by State and Gender"
  },
  "width": 700,
  "height": 400,
  "data": { "url": "arrivals_gender_by_state.csv" },
  "params": [
    {
      "name": "year_select",
      "value": 2020,
      "bind": {
        "input": "select",
        "options": [2020, 2021, 2022, 2023, 2024],
        "labels": ["2020", "2021", "2022", "2023", "2024"],
        "name": "Select Year: "
      }
    }
  ],
  "layer": [
    {

      "transform": [
        { "filter": "datum.year == year_select" },
        { "fold": ["arrivals_male", "arrivals_female"], "as": ["gender", "arrivals"] },
        { "calculate": "replace(datum.gender, 'arrivals_', '')", "as": "gender" }
      ],
      "mark": { "type": "bar", "opacity": 0.9 },
      "encoding": {
        "x": {
          "field": "soe",
          "type": "nominal",
          "title": "State of Entry",
          "sort": "-y",
          "axis": { "labelAngle": -45, "labelFontSize": 11 }
        },
        "y": {
          "field": "arrivals",
          "type": "quantitative",
          "aggregate": "sum",
          "title": "Total Arrivals (visitors)",
          "stack": null,
          "axis": { "titleFontSize": 12 }
        },
        "xOffset": { "field": "gender" },
        "color": {
          "field": "gender",
          "type": "nominal",
          "scale": {
            "domain": ["female", "male"],
            "range": ["#eb6eb3", "#6ea8eb"]
          },
          "title": "Gender",
          "legend": {
            "orient": "right",
            "titleFontSize": 12,
            "labelFontSize": 11
          }
        },
        "tooltip": [
          { "field": "soe", "title": "State" },
          { "field": "gender", "title": "Gender" },
          { "aggregate": "sum", "field": "arrivals", "title": "Arrivals" }
        ]
      }
    },
    {

      "transform": [
        { "filter": "datum.year == year_select" },
        {
          "aggregate": [
            { "op": "sum", "field": "arrivals_male", "as": "male_total" },
            { "op": "sum", "field": "arrivals_female", "as": "female_total" }
          ],
          "groupby": ["soe"]
        },
        { "calculate": "datum.male_total + datum.female_total", "as": "total_arrivals" },
        {
          "window": [{ "op": "rank", "as": "rank" }],
          "sort": [{ "field": "total_arrivals", "order": "descending" }]
        },
        { "filter": "datum.rank == 1" },
        {
          "calculate": "'Top State: ' + datum.soe + ' (' + format(datum.total_arrivals, ',') + ' arrivals)'",
          "as": "label"
        }
      ],
      "mark": {
        "type": "text",
        "align": "center",
        "dy": -2,
        "fontSize": 13,
        "fontWeight": "bold",
        "color": "#b30000"
      },
      "encoding": {
        "x": { "field": "soe", "type": "nominal", "axis": null },
        "y": { "field": "total_arrivals", "type": "quantitative", "axis": null },
        "text": { "field": "label" }
      }
    }
  ],

  "resolve": { "scale": { "x": "independent", "y": "independent" } },

  "config": {
    "view": { "stroke": "transparent" },
    "axis": {
      "domainColor": "#ddd",
      "gridColor": "#f0f0f0",
      "tickColor": "#ddd"
    }
  }
}
